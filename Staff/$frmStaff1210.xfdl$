<?xml version="1.0" encoding="utf-8"?>
<FDL version="2.1">
  <Form id="frmStaff1210" width="1600" height="900" titletext="사이렌 오더(진행 화면)" onload="frmStaff1210_onload" background="white">
    <Layouts>
      <Layout height="900" mobileorientation="landscape" width="1600">
        <Static id="Static01_00_00_00_00" taborder="0" text="FRAME" left="0" top="0" width="250" background="red" opacity="20%" textAlign="center" visible="false" bottom="0"/>
        <Static id="Static01_00_01_00" taborder="1" text="FRAME" left="0" top="880" height="20" background="red" opacity="20%" textAlign="center" visible="false" right="0"/>
        <Static id="Static01_00_00_00" taborder="2" text="FRAME" left="1350" top="0" width="250" background="red" opacity="20%" textAlign="center" visible="false" bottom="0"/>
        <Static id="Static01_00_01" taborder="3" text="FRAME" left="0" top="0" height="20" background="red" opacity="20%" textAlign="center" visible="false" right="0"/>
        <Grid id="grdOrderList" taborder="4" left="1630" top="18" width="1100" height="492" binddataset="ds_orderList" autofittype="col" visible="false">
          <Formats>
            <Format id="default">
              <Columns>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
              </Columns>
              <Rows>
                <Row size="24" band="head"/>
                <Row size="24"/>
              </Rows>
              <Band id="head">
                <Cell text="ORDER_ID"/>
                <Cell col="1" text="NAME"/>
                <Cell col="2" text="PRODUCT_NAME"/>
                <Cell col="3" text="COUNT"/>
                <Cell col="4" text="STATUS_TYPE"/>
                <Cell col="5" text="ORDERED_AT"/>
              </Band>
              <Band id="body">
                <Cell text="bind:ORDER_ID" suppress="1"/>
                <Cell col="1" text="bind:NAME" suppress="1"/>
                <Cell col="2" text="bind:PRODUCT_NAME"/>
                <Cell col="3" text="bind:COUNT"/>
                <Cell col="4" text="bind:STATUS_TYPE" displaytype="combocontrol" edittype="combo" combodataset="ds_display" combocodecol="STATUS_TYPE" combodatacol="STATUS_TEXT"/>
                <Cell col="5" text="bind:ORDERED_AT" suppress="1"/>
              </Band>
            </Format>
          </Formats>
        </Grid>
        <Static id="staTitle" taborder="5" text="현재 진행 중인 주문" left="250" top="120" width="805" height="83" font="normal 600 21pt/normal &quot;KopubWorld&quot;"/>
        <Static id="staStore" taborder="6" text="STORE_NAME 점" left="250" top="64" width="301" height="56" font="normal 600 13px/normal &quot;KopubWorld&quot;" color="#01a862"/>
      </Layout>
    </Layouts>
    <Objects>
      <XPush id="XPush00" onerror="XPush00_onerror" onkeepalive="XPush00_onkeepalive" onsuccess="XPush00_onsuccess"/>
      <Dataset id="dsTopic">
        <ColumnInfo>
          <Column id="Chk" type="STRING" size="256"/>
          <Column id="TOPIC_ID" type="STRING" size="256"/>
          <Column id="TOPIC_NAME" type="STRING" size="256"/>
        </ColumnInfo>
        <Rows>
          <Row>
            <Col id="TOPIC_ID">ALL</Col>
            <Col id="TOPIC_NAME">전체</Col>
          </Row>
          <Row>
            <Col id="TOPIC_ID">TOBEEDU01</Col>
            <Col id="TOPIC_NAME">EDU01</Col>
          </Row>
          <Row>
            <Col id="TOPIC_ID">TOBEEDU02</Col>
            <Col id="TOPIC_NAME">EDU02</Col>
          </Row>
          <Row>
            <Col id="TOPIC_ID">TOBEEDU03</Col>
            <Col id="TOPIC_NAME">EDU03</Col>
          </Row>
          <Row>
            <Col id="TOPIC_ID">TOBEEDU04</Col>
            <Col id="TOPIC_NAME">EDU04</Col>
          </Row>
          <Row>
            <Col id="TOPIC_ID">TOBEEDU05</Col>
            <Col id="TOPIC_NAME">EDU05</Col>
          </Row>
          <Row>
            <Col id="TOPIC_ID">TOBEEDU06</Col>
            <Col id="TOPIC_NAME">EDU06</Col>
          </Row>
        </Rows>
      </Dataset>
      <Dataset id="dsMessage">
        <ColumnInfo>
          <Column id="TOPIC_ID" type="STRING" size="256"/>
          <Column id="TOPIC_TYPE" type="STRING" size="256"/>
          <Column id="CODE" type="STRING" size="256"/>
          <Column id="MSG" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="dsProvider">
        <ColumnInfo>
          <Column id="PROJECT_ID" type="STRING" size="256"/>
          <Column id="PUSH_TYPE" type="STRING" size="256"/>
          <Column id="TOPIC_TYPE" type="STRING" size="256"/>
          <Column id="TOPIC_ID" type="STRING" size="256"/>
          <Column id="CODE" type="STRING" size="256"/>
          <Column id="MSG" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_orderList" oncolumnchanged="ds_orderList_oncolumnchanged">
        <ColumnInfo>
          <Column id="ORDER_ID" type="STRING" size="256"/>
          <Column id="LOGIN_EMAIL" type="STRING" size="256"/>
          <Column id="NAME" type="STRING" size="256"/>
          <Column id="PRODUCT_NAME" type="STRING" size="256"/>
          <Column id="COUNT" type="INT" size="256"/>
          <Column id="STATUS_TYPE" type="INT" size="256"/>
          <Column id="ORDERED_AT" type="DATETIME" size="256"/>
        </ColumnInfo>
        <Rows>
          <Row>
            <Col id="ORDER_ID">1</Col>
            <Col id="LOGIN_EMAIL">1</Col>
          </Row>
        </Rows>
      </Dataset>
      <Dataset id="ds_display">
        <ColumnInfo>
          <Column id="STATUS_TYPE" type="INT" size="256"/>
          <Column id="STATUS_TEXT" type="STRING" size="256"/>
        </ColumnInfo>
        <Rows>
          <Row>
            <Col id="STATUS_TYPE">0</Col>
            <Col id="STATUS_TEXT">주문 수락 대기 중</Col>
          </Row>
          <Row>
            <Col id="STATUS_TYPE">1</Col>
            <Col id="STATUS_TEXT">주문 확인</Col>
          </Row>
          <Row>
            <Col id="STATUS_TYPE">2</Col>
            <Col id="STATUS_TEXT">제조 중</Col>
          </Row>
          <Row>
            <Col id="STATUS_TYPE">4</Col>
            <Col id="STATUS_TEXT">제조 완료</Col>
          </Row>
          <Row>
            <Col id="STATUS_TYPE">8</Col>
            <Col id="STATUS_TEXT">픽업 완료</Col>
          </Row>
        </Rows>
      </Dataset>
    </Objects>
    <Script type="xscript5.1"><![CDATA[/**
*  Nexacro Professional Training Couse
*  @MenuPath    개발가이드 > 표준 및 기본 정의 > 그리드 페이징
*  @FileName 	SamplePaging.xfdl 
*  @Creator 	TOBESOFT Education
*  @CreateDate 	2025/01/03
*  @Desction    
************** 소스 수정 이력 ***********************************************
*  date          		Modifier                Description
*******************************************************************************
*  2026/02/12      		 이아인	 	  	       최초 생성 
*******************************************************************************
*/



/************************************************************************************************
 * FORM 변수 선언 영역
 ************************************************************************************************/
this.fvApp = nexacro.getApplication();

//var strTopicID = "JKIINZ9T"; // STORE_ID로 추후 수정
this.strStoreName = "";
var strTopicID = this.fvApp.gdsAuth.getColumn(0, "STORE_CODE");
var strPushType = "PUSH";

/************************************************************************************************
 * FORM EVENT 영역(onload, onbeforeclose)
 ************************************************************************************************/
/**
 * @description example: ~하는 부분
*/
this.frmStaff1210_onload = function(obj:nexacro.Form,e:nexacro.LoadEventInfo)
{

	// 현재의 onload 주석 처리 -> push 혹은 timer 관련
    this.dsTopic.clearData();
	
    //var nRow = this.dsTopic.addRow();
    //this.dsTopic.setColumn(nRow, "TOPIC_ID", strTopicID);
    //this.dsTopic.setColumn(nRow, "TOPIC_NAME", "매장주문알림");

	this.setStoreName();

    //this.fnXPushStart(); 
    this.fnGetOrderList();
	
	//this.setTimer(2, 5000); 
};

/************************************************************************************************
 * CALLBACK 콜백 처리부분(Transaction, Popup)
 ************************************************************************************************/
this.fn_callback = function(svcId, errCd, errMsg)
{
	if(errCd < 0){ alert("에러 : " + errMsg); }
	
	if(svcId == "svcGetStoreName"){
		this.staStore.text = this.strStoreName+" 점";
		this.staStore.fittocontents = "width";
	}
	
	if(svcId == "svcGetOrderList"){
		this.setProdList();
		//this.resetScroll();
	}
}


/************************************************************************************************
 * CRUD 및 TRANSACTION 서비스 호출 처리
 ************************************************************************************************/
this.fnGetOrderList = function ()
{
	var sSvcId  = "svcGetOrderList";
	var sUrl    = "p024/getOrderList.do";
	var inData  = "";
	var outData = "ds_orderList=out_data";
	var sParam  = "strTopicId="+strTopicID;
	this.gfnTransaction(sSvcId, sUrl, inData, outData, sParam, "fn_callback");
};

this.fnGetStoreName = function ()
{
	var sSvcId  = "svcGetStoreName";
	var sUrl    = "p024/getStoreName.do";
	var inData  = "";
	var outData = "";
	var sParam  = "storeCode="+strTopicID;
	this.gfnTransaction(sSvcId, sUrl, inData, outData, sParam, "fn_callback");
};

/************************************************************************************************
 * 사용자 FUNCTION 영역
 ************************************************************************************************/
this.setStoreName = function ()
{
	this.fnGetStoreName();
};

this.frmCust1210_ontimer = function(obj:nexacro.Form,e:nexacro.TimerEventInfo)
{
    if (e.timerid == 2) {
        this.fnGetOrderList();
    }
};

this.fnXPushStart = function ()
{
    this.XPush00.set_projectid("TOBE_EDU");
    // 사용 가능한 모든 프로토콜/IP 리스트 세팅
    this.XPush00.set_iplist("tcp://localhost:50001, http://localhost:50000, http://172.10.14.128:50000");
    
    // 매장 코드를 ID 삼아 접속
    this.XPush00.connect(strTopicID, "..."); 
};
this.XPush00_onsuccess = function(obj:nexacro.XPush,e:nexacro.XPushEventInfo)
{
    if(e.action == 0) { // Connect 성공
        // dsMessage를 수신용 데이터셋으로 지정하여 구독
        this.XPush00.subscribe("9999", strTopicID, this, this.dsMessage, "append", "fn_push_callback");
    }
    if(e.action == 2) this.XPush00.registerTopic("9999", strTopicID);
};

// 2. 푸시 수신 시 (dsMessage에 데이터가 들어왔을 때)
this.fn_push_callback = function(Row, ChangeColumn, AllColumns, Type, ActionType, MessageId)
{
    if(ActionType == "PUSH") {
        // dsMessage의 CODE(손님ID)나 MSG(주문번호)를 확인하고 그리드 갱신
        this.fnGetOrderList(); 
    }
};

// 3. 주문 상태 변경 및 손님에게 푸시 전송 (버튼 클릭 이벤트 등)
this.btnUpdateStatus = function(status) // status: 2(제조중), 4(제조완료), 8(픽업완료)
{
    var ordRow = this.ds_orderList.rowposition;
    var targetCust = this.ds_orderList.getColumn(ordRow, "LOGIN_EMAIL");
    var orderId = this.ds_orderList.getColumn(ordRow, "ORDER_ID");

    this.dsProvider.clearData();
    var pRow = this.dsProvider.addRow();
    this.dsProvider.setColumn(pRow, "PROJECT_ID", "TOBE_EDU");
    this.dsProvider.setColumn(pRow, "PUSH_TYPE", "PUSH");
    this.dsProvider.setColumn(pRow, "TOPIC_TYPE", "9999"); // 모르셨던 부분
    this.dsProvider.setColumn(pRow, "TOPIC_ID", targetCust); // 수신자: 손님 이메일
    this.dsProvider.setColumn(pRow, "CODE", orderId);       // 어떤 주문인지
    this.dsProvider.setColumn(pRow, "MSG", status);         // 변경된 상태값

    var sSvcId  = "svcUpdateStatus";
    var sUrl    = "p024/updateStatus.do";
    var inData  = "dsProvider=dsProvider:u"; // 변경된 dsProvider 전달
    var outData = "";
    var sParam  = "";
    
    this.gfnTransaction(sSvcId, sUrl, inData, outData, sParam, "fn_callback");

};

/************************************************************************************************
 * 각 COMPONENT 별 EVENT 영역
 ************************************************************************************************/
this.makeTitle = function (objDiv, sOrderId)
{
    var staTitle = new Static();
    var sStaId = "staProdTitle_" + sOrderId;
    
    // 부모 Div 내부 상단에 고정 (0, 0 위치)
    staTitle.init(sStaId, 0, 0, null, 50, 0); 
        
    staTitle.set_text(" 주문번호 : " + sOrderId);
    staTitle.set_textAlign("left");
    staTitle.set_font("normal bold 16px/normal 'KopubWorld'");
    staTitle.set_background("#f4f4f2");
    staTitle.set_padding("0px 0px 0px 10px");
    
    objDiv.form.addChild(sStaId, staTitle);
    staTitle.show();
};

// 1. 상품명 생성
this.makeStaName = function (objDiv, objDs, i, nItemY) // 인자 순서와 개수 확인!
{
    var sId = "staProdName_" + objDs.getColumn(i, "ORDER_ID") + "_" + i;
    var staProdName = new Static();
    
    // 부모 Div 내부에서 nItemY 좌표에 배치
    staProdName.init(sId, 10, nItemY, 260, 30);
    staProdName.set_text(objDs.getColumn(i, "PRODUCT_NAME"));
    staProdName.set_font("normal bold 13px/normal 'KopubWorld'");
    staProdName.set_color("#000000"); 
    
    objDiv.form.addChild(sId, staProdName); // objDiv를 직접 사용
    staProdName.show();
};

// 2. 수량 생성
this.makeStaCount = function (objDiv, objDs, i, nItemY)
{
    var sId = "staProdCount_" + i;
    var staCount = new Static();
    
    staCount.init(sId, 300, nItemY, 100, 30); // 좌표 겹치지 않게 조정
    var nCount = objDs.getColumn(i, "COUNT");
    staCount.set_text(nexacro.toNumber(nCount).toLocaleString() + "개");
    staCount.set_color("#ff5500");
    
    objDiv.form.addChild(sId, staCount);
    staCount.show();
};

// 3. 버튼 생성
this.makeBtnStatus = function (objDiv, i)
{
    var sId = "btnStatus_" + i;
    var btnStatus = new Button();
    
    btnStatus.init(sId, null, null, 100, 35, 20, 10); // 우측 하단 배치
    btnStatus.set_text("주문 수락");
    btnStatus.set_background("white");
    btnStatus.set_border("1px solid black");
    
    // 주의: ds_drinkInfo가 없으면 에러 납니다. ds_orderList로 확인해보세요.
    // btnStatus.prodId = this.ds_orderList.getColumn(i, "STATUS_TYPE"); 
    
    btnStatus.addEventHandler("onclick", this.btnUpdateStatus, this);
    
    objDiv.form.addChild(sId, btnStatus);
    btnStatus.show();
};

this.setProdList = function ()
{
    this.deleteDiv(); // 기존 UI 초기화
    
    var objDs = this.ds_orderList;
    if (objDs == null || objDs.getRowCount() == 0) return;

    var nCardW   = 1100;
    var nGapY    = 20;
    var nStartX  = 250;
    var nTop     = 400;
    
    var sPrevOrderId = "";
    var objDiv = null;
    var nItemY = 0; // Div 내부에서 상품이 그려질 Y 좌표

    for(var i=0; i < objDs.getRowCount(); i++)
    {
        var sCurrOrderId = objDs.getColumn(i, "ORDER_ID");

        // [STEP 1] 새로운 주문번호가 등장하면 큰 도화지(Div) 생성
        if (sCurrOrderId != sPrevOrderId) 
        {
            // 이전 주문의 버튼을 생성 (첫 번째 루프 제외)
            if(objDiv != null) this.makeBtnStatus(objDiv, i-1);

            var sDivId = "divCard_" + sCurrOrderId;
            objDiv = new Div();
            // 높이는 일단 작게 잡고, 상품 개수에 따라 늘리거나 고정
            objDiv.init(sDivId, nStartX, nTop, nCardW, 200); 
            objDiv.set_border("2px solid #2d2d2d");
            objDiv.set_background("#ffffff");
            this.addChild(sDivId, objDiv);
            objDiv.show();

            // 주문번호 제목 생성
            this.makeTitle(objDiv, sCurrOrderId);
            
            nItemY = 60; // 타이틀 아래부터 상품 시작
            sPrevOrderId = sCurrOrderId;
            
            // 다음 Div를 위한 좌표 계산 (현재는 임시 높이 200 기준)
            nTop += (200 + nGapY); 
        }

        // [STEP 2] 동일한 주문번호 내에서 상품들 나열
        this.makeStaName(objDiv, objDs, i, nItemY);
        this.makeStaCount(objDiv, objDs, i, nItemY);
        
        nItemY += 40; // 다음 상품을 위해 Y축 이동
        
        // Div 높이 자동 조절 (상품이 많아지면 Div도 길어지게)
        objDiv.set_height(nItemY + 60); // 버튼 들어갈 자리 확보
    }
    
    // 마지막 주문건의 버튼 생성
    if(objDiv != null) this.makeBtnStatus(objDiv, objDs.getRowCount()-1);
    
    this.resetScroll();
};


this.deleteDiv = function ()
{
    for(var i = this.components.length - 1; i >= 0; i--) // 컴포넌트 삭제 시 id 충돌 때문에 역순 삭제
    {
        var obj = this.components[i];
		if(obj instanceof nexacro.Static && obj.id.indexOf("staProdTitle") == 0)
        {
            this.removeChild(obj.id).destroy();
        }
        if(obj instanceof nexacro.Div && obj.id.indexOf("divCard_") == 0)
        {
            this.removeChild(obj.id).destroy();
        }
    }
};


// this.ds_orderList_oncolumnchanged = function(obj:nexacro.NormalDataset,e:nexacro.DSColChangeEventInfo)
// {
// 	if(e.columnid == "STATUS_TYPE") {
//         var nStatus = e.newvalue; // 변경된 상태값 (2, 4, 8 등)
//         this.btnUpdateStatus(nStatus); // 서버로 전송 및 푸시 요청
//     }
// };
]]></Script>
    <Bind>
      <BindItem id="item0" compid="grdOrderList" propid="binddataset" datasetid="ds_orderList" columnid=""/>
    </Bind>
  </Form>
</FDL>
